<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Feed de la cocina</title>
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      /* Fondo rojo oscuro fijo (recuperado) */
      background: #764e50; 
      color: #fff;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    header {
      background: #E61C29;
      padding: 20px 30px;
      font-size: 35px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #hora {
      font-size: 23px;
      font-weight: normal;
    }

    .container {
      display: flex;
      height: calc(100vh - 90px);
    }

    .col {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      overflow-x: hidden;
      box-sizing: border-box;
    }

    #col-llegadas { flex: 0 0 55%; }
    #col-horarios { flex: 0 0 45%; }

    .titulo-col {
      font-size: 30px;
      margin-bottom: 15px;
      border-bottom: 2px solid #ffffff;
      padding-bottom: 5px;
      color: #fff; /* Títulos en blanco */
    }

    .linea {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 25px;
    }

    /* Cajitas de horarios */
    .horarios-lista {
      display: flex;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .horario-caja {
      /* Color definido por JS */
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 22px;
      min-width: 80px;
      text-align: center;
      margin: 5px;
      color: #000; /* Texto negro dentro de las cajitas pastel */
    }
  </style>
</head>

<body>

  <header>
    <div>Adormideras en directo</div>
    <div id="hora"></div>
  </header>

  <div class="container">
    <div class="col" id="col-llegadas">
      <div class="titulo-col">Llegadas</div>
      <div id="contenedor"></div>
    </div>

    <div class="col" id="col-horarios">
      <div class="titulo-col">Horarios de hoy</div>
      <div id="horarios"></div>
    </div>
  </div>

</body>

<style>
#banda-inferior {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 55px;
    display: flex;
    align-items: center;
    z-index: 10000;
    overflow: hidden;
    color: #fff;
    font-size: 28px;
}

#banda-lluvia {
    flex: 0 0 auto;
    background: #121212;
    height: 55px;
    width: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
}

#banda-info-derecha {
  flex-grow: 1;
  background: #E61C29; /* Fondo ROJO asegurado */
  height: 55px;
  display: flex;
  align-items: center;
  padding-left: 30px;
  justify-content: flex-start;
}

#cuenta-atras {
    font-weight: normal; /* Letra fina */
    font-size: 26px;
    /* Eliminado text-transform: uppercase */
}
</style>

<div id="banda-inferior">
  <div id="banda-lluvia">Cargando lluvia...</div>
  <div id="banda-info-derecha">
      <div id="cuenta-atras">Actualizando...</div>
  </div>
</div>

</html>

<script>
// ============================
// UTILS
// ============================
function pad(str, len, char) {
    str = String(str);
    var pad = char || '0';
    return str.length >= len ? str : new Array(len - str.length + 1).join(pad) + str;
}

// ============================
// CONFIGURACIÓN
// ============================
var NOMBRES_PARADAS = {};

// DEFINICIÓN DE COLORES: VIVO (Fuerte) y PASTEL (Claro)
var LINEA_INFO = {
    500: { nombre: "Línea 5",  vivo: "#6792bc", pastel: "#e1e9f2" },
    300: { nombre: "Línea 3",  vivo: "#be8b00", pastel: "#f2e9cf" },
    301: { nombre: "Línea 3A", vivo: "#d3b255", pastel: "#f6f0dd" }
};

var proximaActualizacion = 0;

// ============================
// LOGICA
// ============================

function cargarDatosDelWrapper() {
    console.log("Actualizando datos...");
    proximaActualizacion = new Date().getTime() + 30000; 
    
    fetch('/api/datos?t=' + new Date().getTime())
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
            if (data.paradas) procesarParadas(data.paradas);
            setTimeout(function() {
                if (data.llegadas) pintarLlegadas(data.llegadas);
            }, 50);
            if (data.horarios) pintarHorarios(data.horarios); 
            if (data.clima) pintarClima(data.clima);
        })
        .catch(function(err) { console.error(err); });
}

function pintarLlegadas(dataLlegadas) {
    var cont = document.getElementById("contenedor");
    cont.innerHTML = ""; 

    if (!dataLlegadas || !dataLlegadas.buses || !dataLlegadas.buses.lineas) {
        cont.innerHTML = '<p>No hay llegadas.</p>';
        return;
    }

    dataLlegadas.buses.lineas.forEach(function(linea) {
        var config = LINEA_INFO[linea.linea] || { nombre: "L"+linea.linea, vivo: "#666", pastel: "#ccc" };

        var bloque = document.createElement("div");
        bloque.style.display = "flex";
        bloque.style.marginBottom = "15px";
        bloque.style.borderRadius = "10px";
        bloque.style.overflow = "hidden";
        // En llegadas, el fondo grande es el PASTEL
        bloque.style.background = config.pastel; 
        bloque.style.color = "#000"; // Texto negro sobre pastel

        // Caja número gigante (VIVO)
        var lineaDiv = document.createElement("div");
        lineaDiv.textContent = config.nombre.replace("Línea ","");
        lineaDiv.style.width = "120px";
        lineaDiv.style.background = config.vivo; 
        lineaDiv.style.color = "#fff";
        lineaDiv.style.fontSize = "60px";
        lineaDiv.style.fontWeight = "bold";
        lineaDiv.style.display = "flex";
        lineaDiv.style.alignItems = "center";
        lineaDiv.style.justifyContent = "center";
        bloque.appendChild(lineaDiv);

        // Lista de buses
        var llegadasDiv = document.createElement("div");
        llegadasDiv.style.flexGrow = "1";
        llegadasDiv.style.padding = "10px";
        llegadasDiv.style.display = "flex";
        llegadasDiv.style.flexDirection = "column";
        llegadasDiv.style.gap = "8px";

        linea.buses.forEach(function(bus) {
            var elem = document.createElement("div");
            elem.style.display = "flex";
            elem.style.alignItems = "center";
            // Hack espaciado iOS9
            elem.innerHTML = '<span style="font-weight:bold; font-size:38px; margin-right:10px;">' + 
                             ((bus.tiempo == 0) ? "En la parada" : bus.tiempo + " min") + 
                             '</span>';
            
            var nombreParada = document.createElement("span");
            var ultima = NOMBRES_PARADAS[bus.ult_parada]; 
            if (ultima) {
                nombreParada.textContent = "· " + ultima;
                nombreParada.style.fontStyle = "italic";
                nombreParada.style.fontSize = "20px";
                nombreParada.style.opacity = "0.8";
            }
            elem.appendChild(nombreParada);
            llegadasDiv.appendChild(elem);
        });

        bloque.appendChild(llegadasDiv);
        cont.appendChild(bloque);
    });
}

function pintarHorarios(dataHorarios) {
    var cont = document.getElementById("horarios");
    cont.innerHTML = ""; 
    var ahora = horaActualInt();
    
    function procesarLinea(datosLinea, config) {
        if (!datosLinea) return;
        var servicios = datosLinea.servicios ? datosLinea.servicios[0] : null;
        if (!servicios) return;
        var horarios = servicios.ida || servicios.vuelta;
        if (!horarios) return;

        var futuros = horarios.filter(function(h) { return h > ahora; }).slice(0, 6);

        var div = document.createElement("div");
        div.className = "linea";
        
        // CAMBIO SOLICITADO: Caja contenedora = COLOR VIVO
        div.style.background = config.vivo; 
        // Título en blanco para que se lea sobre el color vivo
        div.innerHTML = "<h2 style='margin:0 0 10px; font-size:28px; font-weight:bold; color:#fff'>" 
                        + config.nombre + "</h2>";
        
        var lista = document.createElement("div");
        lista.className = "horarios-lista";
        
        if (futuros.length === 0) {
            lista.innerHTML = "<div style='padding:10px; color:#fff'>Fin del servicio</div>";
        } else {
            futuros.forEach(function(h) {
                var caja = document.createElement("div");
                caja.className = "horario-caja";
                caja.textContent = formatearHora(h);
                
                // CAMBIO SOLICITADO: Cajitas pequeñitas = COLOR PASTEL
                caja.style.background = config.pastel; 
                caja.style.color = "#000"; // Texto negro sobre pastel
                
                lista.appendChild(caja);
            });
        }
        div.appendChild(lista);
        cont.appendChild(div);
    }

    if (dataHorarios.linea5) procesarLinea(dataHorarios.linea5, LINEA_INFO[500]);
    if (dataHorarios.linea3) procesarLinea(dataHorarios.linea3, LINEA_INFO[300]);
    if (dataHorarios.linea3A) procesarLinea(dataHorarios.linea3A, LINEA_INFO[301]);
}

function pintarClima(dataClima) {
    var bandaLluvia = document.getElementById("banda-lluvia");
    var ahora = new Date();
    var textoLluvia = '<span style="font-size: 40px; margin-right: 8px;">☀️</span> Sin lluvias';

    if (dataClima && dataClima.hourly) {
        var tiempos = dataClima.hourly.time;
        var pops = dataClima.hourly.precipitation_probability;
        for (var i=0; i<tiempos.length; i++) {
            var fechaItem = new Date(tiempos[i]);
            if (fechaItem < ahora) continue;
            if (pops[i] >= 40) {
                var diff = (fechaItem - ahora) / 3600000;
                if (diff > 120) break;
                
                if (diff <= 1) textoLluvia = '☔ Lluvia ahora';
                else if (diff < 6) textoLluvia = '☔ Lluvia en ' + Math.ceil(diff) + 'h';
                else if (fechaItem.getDate() == ahora.getDate()) 
                     textoLluvia = '☔ Lluvia a las ' + pad(fechaItem.getHours(),2) + ':00';
                else textoLluvia = '☔ Lluvia mañana';
                
                // Añadir icono
                textoLluvia = textoLluvia.replace('☔', '<span style="font-size: 40px; margin-right: 8px;">☔</span>');
                break;
            }
        }
    }
    bandaLluvia.innerHTML = textoLluvia;
}

function actualizarReloj() {
    var ahora = new Date();
    var fecha = ahora.toLocaleDateString("es-ES", { weekday: "long", month: "long", day: "numeric" });
    var hora = pad(ahora.getHours(), 2) + ":" + pad(ahora.getMinutes(), 2) + ":" + pad(ahora.getSeconds(), 2);
    var elem = document.getElementById("hora");
    if (elem) elem.innerHTML = fecha + " — " + hora;
}

function actualizarCuentaAtras() {
    var div = document.getElementById("cuenta-atras");
    if (!div) return;
    var ahora = new Date().getTime();
    var faltan = Math.ceil((proximaActualizacion - ahora) / 1000);
    if (faltan < 0) faltan = 0;
    // Texto en minúsculas/mixtas
    div.textContent = "Próxima actualización en " + faltan + "s";
}

function formatearHora(num) {
    var s = pad(num, 4, '0');
    return s.slice(0,2) + ":" + s.slice(2);
}

function horaActualInt() {
    var d = new Date();
    return d.getHours() * 100 + d.getMinutes();
}

function procesarParadas(textoParadas) {
    try {
        var regex = /\{[^{}]*"id":[0-9]+,"nombre":"[^"]+"[^{}]*\}/g;
        var matches = textoParadas.match(regex);
        NOMBRES_PARADAS = {}; 
        if (matches) {
            matches.forEach(function(s) {
                var obj = JSON.parse(s);
                NOMBRES_PARADAS[obj.id] = obj.nombre;
            });
        }
    } catch (e) {}
}

setInterval(actualizarReloj, 1000);
setInterval(actualizarCuentaAtras, 1000);
actualizarReloj();

document.addEventListener("DOMContentLoaded", function() {
    cargarDatosDelWrapper();
    setInterval(cargarDatosDelWrapper, 30000); 
});
</script>