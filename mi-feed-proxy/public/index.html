<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Feed de la cocina</title>
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #764e50;
      color: #fff;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    header {
      background: #E61C29;
      /* Changed padding-top to 35px to make room for the status bar */
      padding: 25px 25px 15px 25px; 
      font-size: 32px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #hora {
      font-size: 22px;
      font-weight: normal;
    }

    .container {
      display: flex;
      height: calc(100vh - 85px);
    }

    .col {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      overflow-x: hidden;
      box-sizing: border-box;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }

    /* LAYOUT 59:41 */
    #col-llegadas {
      flex: 0 0 57.5%;
      max-width: 57.5%; 
      width: 57.5%; 
    }

    #col-horarios {
      flex: 0 0 42.5%;
      max-width: 42.5%;
      width: 42.5%;
    }

    .titulo-col {
      font-size: 26px;
      margin-bottom: 12px;
      border-bottom: 2px solid #ffffff;
      padding-bottom: 4px;
      color: #fff;
    }

    .linea {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .horarios-lista {
      display: flex;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .horario-caja {
      padding: 10px 6px; 
      border-radius: 8px;
      font-size: 20px;
      min-width: 70px;
      text-align: center;
      margin: 4px;
      color: #000;
    }
  </style>
</head>

<body>

  <header>
    <div>Adormideras en directo</div>
    <div id="hora"></div>
  </header>

  <div class="container">
    <div class="col" id="col-llegadas">
      <div class="titulo-col">Llegadas</div>
      <div id="contenedor"></div>
    </div>

    <div class="col" id="col-horarios">
      <div class="titulo-col">Horarios de hoy</div>
      <div id="horarios"></div>
    </div>
  </div>
  <div onclick="window.location.reload();" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: rgb(0, 0, 0);
    border-radius: 50%;
    z-index: 10999;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
">
    <span style="font-size: 24px; color: white;">&#x21bb;</span>
</div>

</body>

<style>
#banda-inferior {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 50px;
    display: flex;
    align-items: center; /* Esto centra verticalmente todo */
    z-index: 10000;
    overflow: hidden;
    color: #fff;
    font-size: 24px;
}

#banda-lluvia {
    flex: 0 0 auto;
    background: #121212;
    height: 100%;
    width: 280px;
    display: flex;
    align-items: center; /* Centrado vertical flex */
    justify-content: center;
    white-space: nowrap;
    padding: 0 10px; /* Un poco de aire */
}

#banda-info-derecha {
  flex-grow: 1;
  background: #E61C29;
  height: 100%;
  display: flex;
  align-items: center;
  padding-left: 25px;
  justify-content: flex-start;
}

#cuenta-atras {
    font-weight: normal;
    font-size: 24px;
}

/* Clases para el clima */
.clima-emoji {
    font-size: 1.3em; /* 30% m√°s grande que el texto, relativo */
    margin-right: 10px;
    line-height: 1; /* Evita que estire la altura */
}
.clima-texto {
    /* Sin estilos raros, hereda la alineaci√≥n flex */
}
</style>

<div id="banda-inferior">
  <div id="banda-lluvia">Cargando lluvia...</div>
  <div id="banda-info-derecha">
      <div id="cuenta-atras">Actualizando...</div>
  </div>
</div>

</html>

<script>
// ============================
// UTILS
// ============================
function pad(str, len, char) {
    str = String(str);
    var pad = char || '0';
    return str.length >= len ? str : new Array(len - str.length + 1).join(pad) + str;
}

// ============================
// CONFIGURACI√ìN
// ============================
var NOMBRES_PARADAS = {};

// Mapeo para conectar el ID de la l√≠nea en llegadas con la propiedad en el JSON de horarios
var MAPA_HORARIOS = {
    500: "linea5",
    300: "linea3",
    301: "linea3A"
};

var LINEA_INFO = {
    500: { nombre: "L√≠nea 5",  vivo: "#6792bc", pastel: "#e1e9f2" },
    300: { nombre: "L√≠nea 3",  vivo: "#be8b00", pastel: "#f2e9cf" },
    301: { nombre: "L√≠nea 3A", vivo: "#d3b255", pastel: "#f6f0dd" }
};

var proximaActualizacion = 0;
var CACHE_HORARIOS = null; // Guardaremos aqu√≠ los horarios para usarlos en llegadas

// ============================
// LOGICA
// ============================

function cargarDatosDelWrapper() {
    if (document.hidden) {
        console.log("Pantalla oculta: saltando actualizaci√≥n.");
        return;
    }

    console.log("Actualizando datos...");
    proximaActualizacion = new Date().getTime() + 30000; 
    
    fetch('/api/datos?t=' + new Date().getTime())
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
            // 1. Guardamos horarios en global antes de pintar nada
            if (data.horarios) {
                CACHE_HORARIOS = data.horarios;
                pintarHorarios(data.horarios); 
            }

            if (data.paradas) procesarParadas(data.paradas);
            
            // 2. Pintamos llegadas (ahora usar√° CACHE_HORARIOS internamente)
            setTimeout(function() {
                if (data.llegadas) pintarLlegadas(data.llegadas);
            }, 50);

            if (data.clima) pintarClima(data.clima);
        })
        .catch(function(err) { console.error(err); });
}

// Funci√≥n auxiliar para buscar a qu√© hora sale el bus que est√° en la parada
function obtenerSiguienteSalidaHHMM(idLinea) {
    if (!CACHE_HORARIOS) return null;
    
    var key = MAPA_HORARIOS[idLinea];
    if (!key || !CACHE_HORARIOS[key]) return null;

    var datosLinea = CACHE_HORARIOS[key];
    // Asumimos estructura: { servicios: [ { ida: [...], vuelta: [...] } ] }
    // Normalmente la parada principal (151) suele ser el inicio o fin, revisa si es ida o vuelta.
    // Por defecto miramos ambos o la estructura que usas en pintarHorarios.
    
    var servicios = datosLinea.servicios ? datosLinea.servicios[0] : null;
    if (!servicios) return null;
    
    // Unimos ida y vuelta para buscar la pr√≥xima salida global (simplificaci√≥n)
    // Ojo: Si la parada 151 es solo de ida, usa solo servicios.ida
    var todosHorarios = (servicios.ida || []).concat(servicios.vuelta || []);
    todosHorarios.sort(function(a, b){return a-b}); // Ordenar num√©ricamente

    var ahora = horaActualInt();
    
    // Buscar el primer horario estrictamente mayor que ahora
    for (var i = 0; i < todosHorarios.length; i++) {
        if (todosHorarios[i] > ahora) {
            return todosHorarios[i]; // Devuelve 1234 (int)
        }
    }
    return null;
}

function pintarLlegadas(dataLlegadas) {
    var cont = document.getElementById("contenedor");
    cont.innerHTML = ""; 

    if (!dataLlegadas || !dataLlegadas.buses || !dataLlegadas.buses.lineas) {
        cont.innerHTML = '<p>No hay llegadas.</p>';
        return;
    }

    dataLlegadas.buses.lineas.forEach(function(linea) {
        var config = LINEA_INFO[linea.linea] || { nombre: "L"+linea.linea, vivo: "#666", pastel: "#ccc" };

        var bloque = document.createElement("div");
        bloque.style.display = "flex";
        bloque.style.marginBottom = "15px";
        bloque.style.borderRadius = "10px";
        bloque.style.overflow = "hidden";
        bloque.style.background = config.pastel; 
        bloque.style.color = "#000";

        var lineaDiv = document.createElement("div");
        lineaDiv.textContent = config.nombre.replace("L√≠nea ","");
        lineaDiv.style.width = "100px";
        lineaDiv.style.background = config.vivo; 
        lineaDiv.style.color = "#fff";
        lineaDiv.style.fontSize = "50px";
        lineaDiv.style.fontWeight = "bold";
        lineaDiv.style.display = "flex";
        lineaDiv.style.alignItems = "center";
        lineaDiv.style.justifyContent = "center";
        lineaDiv.style.flexShrink = "0";
        bloque.appendChild(lineaDiv);

        var llegadasDiv = document.createElement("div");
        llegadasDiv.style.flexGrow = "1";
        llegadasDiv.style.padding = "8px 10px";
        llegadasDiv.style.display = "flex";
        llegadasDiv.style.flexDirection = "column";
        llegadasDiv.style.gap = "6px";
        llegadasDiv.style.minWidth = "0";

        linea.buses.forEach(function(bus) {
            var esEnParada = (bus.tiempo === 0 || bus.tiempo === "0");
            
            var elem = document.createElement("div");
            elem.style.display = "flex";
            elem.style.alignItems = "center";
            elem.style.minWidth = "0";
            
            var spanTiempo = document.createElement("span");
            spanTiempo.textContent = esEnParada ? "En la parada" : bus.tiempo + " min";
            spanTiempo.style.fontWeight = "bold";
            spanTiempo.style.fontSize = "32px";
            spanTiempo.style.marginRight = "10px";
            spanTiempo.style.whiteSpace = "nowrap";
            spanTiempo.style.flexShrink = "0";
            elem.appendChild(spanTiempo);
            
            if (!esEnParada) {
                var nombreParada = document.createElement("span");
                var ultima = NOMBRES_PARADAS[bus.ult_parada]; 
                if (ultima) {
                    nombreParada.textContent = "¬∑ " + ultima;
                    nombreParada.style.fontStyle = "italic";
                    nombreParada.style.fontSize = "18px";
                    nombreParada.style.opacity = "0.8";
                    nombreParada.style.whiteSpace = "nowrap";
                    nombreParada.style.overflow = "hidden";
                    nombreParada.style.textOverflow = "ellipsis";
                    nombreParada.style.minWidth = "0"; 
                    elem.appendChild(nombreParada);
                }
            } else {
                // === NUEVA L√ìGICA: Cuenta atr√°s para salida ===
                var horaSalida = obtenerSiguienteSalidaHHMM(linea.linea);
                if (horaSalida) {
                    var spanCuentaAtras = document.createElement("span");
                    spanCuentaAtras.className = "cuenta-atras-salida"; // Clase para buscarla luego
                    spanCuentaAtras.setAttribute("data-salida", horaSalida); // Guardamos 1234
                    spanCuentaAtras.style.color = "#D32F2F"; // Rojo oscuro legible
                    spanCuentaAtras.style.fontSize = "32px"; // Mismo tama√±o que "En la parada"
                    spanCuentaAtras.style.fontWeight = "bold";
                    spanCuentaAtras.style.marginLeft = "5px";
                    
                    // Texto inicial (se actualizar√° en < 1 seg por el intervalo)
                    spanCuentaAtras.textContent = "¬∑ Sale en --:--";
                    
                    elem.appendChild(spanCuentaAtras);
                }
            }
            llegadasDiv.appendChild(elem);
        });

        bloque.appendChild(llegadasDiv);
        cont.appendChild(bloque);
    });
    
    // Forzamos una actualizaci√≥n inmediata de los relojes
    actualizarCuentasAtrasSalidas();
}

function pintarHorarios(dataHorarios) {
    var cont = document.getElementById("horarios");
    cont.innerHTML = ""; 
    var ahora = horaActualInt();
    
    function procesarLinea(datosLinea, config) {
        if (!datosLinea) return;
        var servicios = datosLinea.servicios ? datosLinea.servicios[0] : null;
        if (!servicios) return;
        var horarios = servicios.ida || servicios.vuelta;
        if (!horarios) return;

        var futuros = horarios.filter(function(h) { return h > ahora; }).slice(0, 8);

        var div = document.createElement("div");
        div.className = "linea";
        div.style.background = config.vivo; 
        div.innerHTML = "<h2 style='margin:0 0 8px; font-size:24px; font-weight:bold; color:#fff'>" 
                        + config.nombre + "</h2>";
        
        var lista = document.createElement("div");
        lista.className = "horarios-lista";
        
        if (futuros.length === 0) {
            lista.innerHTML = "<div style='padding:8px; color:#fff; font-size:18px;'>Fin del servicio</div>";
        } else {
            futuros.forEach(function(h) {
                var caja = document.createElement("div");
                caja.className = "horario-caja";
                caja.textContent = formatearHora(h);
                caja.style.background = config.pastel; 
                caja.style.color = "#000"; 
                lista.appendChild(caja);
            });
        }
        div.appendChild(lista);
        cont.appendChild(div);
    }

    if (dataHorarios.linea5) procesarLinea(dataHorarios.linea5, LINEA_INFO[500]);
    if (dataHorarios.linea3) procesarLinea(dataHorarios.linea3, LINEA_INFO[300]);
    if (dataHorarios.linea3A) procesarLinea(dataHorarios.linea3A, LINEA_INFO[301]);
}

function pintarClima(dataClima) {
    var bandaLluvia = document.getElementById("banda-lluvia");
    var ahora = new Date();
    
    var sol = '<span class="clima-emoji">‚òÄÔ∏è</span>';
    var lluvia = '<span class="clima-emoji">üåßÔ∏è</span>';
    var htmlFinal = sol + '<span class="clima-texto">Sin lluvias</span>';

    if (dataClima && dataClima.hourly) {
        var tiempos = dataClima.hourly.time;
        var pops = dataClima.hourly.precipitation_probability;
        for (var i=0; i<tiempos.length; i++) {
            var fechaItem = new Date(tiempos[i]);
            if (fechaItem < ahora) continue;
            if (pops[i] >= 40) {
                var diff = (fechaItem - ahora) / 3600000;
                if (diff > 120) break;
                
                var mensaje = "";
                if (diff <= 1) mensaje = 'Lluvia ahora';
                else if (diff < 6) mensaje = 'Lluvia en ' + Math.ceil(diff) + 'h';
                else if (fechaItem.getDate() == ahora.getDate()) 
                     mensaje = 'Lluvia a las ' + pad(fechaItem.getHours(),2) + ':00';
                else mensaje = 'Lluvia ma√±ana';
                
                htmlFinal = lluvia + '<span class="clima-texto">' + mensaje + '</span>';
                break;
            }
        }
    }
    bandaLluvia.innerHTML = htmlFinal;
}

// Nueva funci√≥n llamada cada segundo para mover los segunderos rojos
function actualizarCuentasAtrasSalidas() {
    var elementos = document.querySelectorAll(".cuenta-atras-salida");
    if (elementos.length === 0) return;

    var ahora = new Date();
    
    for (var i = 0; i < elementos.length; i++) {
        var el = elementos[i];
        var hhmm = el.getAttribute("data-salida"); // "1234"
        if (!hhmm) continue;

        // Crear objeto fecha objetivo
        var h = parseInt(hhmm.substring(0, 2), 10);
        var m = parseInt(hhmm.substring(2), 10);
        
        var fechaSalida = new Date();
        fechaSalida.setHours(h, m, 0, 0); // Hora del horario de hoy

        // Calcular diferencia en ms
        var diff = fechaSalida - ahora;

        if (diff > 0) {
            var minutos = Math.floor(diff / 60000);
            var segundos = Math.floor((diff % 60000) / 1000);
            el.textContent = " ¬∑ Sale en " + pad(minutos, 2) + ":" + pad(segundos, 2);
        } else {
            el.textContent = " ¬∑ Saliendo...";
        }
    }
}

function actualizarReloj() {
    var ahora = new Date();
    var fecha = ahora.toLocaleDateString("es-ES", { weekday: "long", month: "long", day: "numeric" });
    var hora = pad(ahora.getHours(), 2) + ":" + pad(ahora.getMinutes(), 2) + ":" + pad(ahora.getSeconds(), 2);
    
    var elem = document.getElementById("hora");
    if (elem) {
        elem.innerHTML = fecha + " ‚Äî <b>" + hora + "</b>";
    }
    
    // Actualizamos los contadores rojos cada segundo tambi√©n
    actualizarCuentasAtrasSalidas();
}

function actualizarCuentaAtras() {
    var div = document.getElementById("cuenta-atras");
    if (!div) return;
    var ahora = new Date().getTime();
    var faltan = Math.ceil((proximaActualizacion - ahora) / 1000);
    if (faltan < 0) faltan = 0;
    
    div.textContent = "Los datos se actualizar√°n en " + faltan + " segundos.";
}

function formatearHora(num) {
    var s = pad(num, 4, '0');
    return s.slice(0,2) + ":" + s.slice(2);
}

function horaActualInt() {
    var d = new Date();
    return d.getHours() * 100 + d.getMinutes();
}

function procesarParadas(textoParadas) {
    try {
        var regex = /\{[^{}]*"id":[0-9]+,"nombre":"[^"]+"[^{}]*\}/g;
        var matches = textoParadas.match(regex);
        NOMBRES_PARADAS = {}; 
        if (matches) {
            matches.forEach(function(s) {
                var obj = JSON.parse(s);
                NOMBRES_PARADAS[obj.id] = obj.nombre;
            });
        }
    } catch (e) {}
}

// ============================
// INICIALIZACI√ìN
// ============================
setInterval(actualizarReloj, 1000);
setInterval(actualizarCuentaAtras, 1000);
actualizarReloj();

document.addEventListener("DOMContentLoaded", function() {
    cargarDatosDelWrapper();
    
    setInterval(cargarDatosDelWrapper, 30000); 
    
    document.addEventListener("visibilitychange", function() {
        if (!document.hidden) {
            console.log("Pesta√±a visible: Forzando actualizaci√≥n.");
            actualizarReloj();
            cargarDatosDelWrapper();
        }
    });
});
</script>
